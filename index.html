<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Inventory System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #0f172a;
      color: #e5e7eb;
    }
    header {
      background: #111827;
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #1f2937;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header h1 {
      margin: 0;
      font-size: 1.25rem;
    }
    .role-area {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      font-size: 0.9rem;
    }
    select, input, button, textarea {
      font: inherit;
      border-radius: 0.375rem;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      padding: 0.4rem 0.6rem;
    }
    button {
      cursor: pointer;
      background: #4f46e5;
      border-color: #4f46e5;
      font-weight: 500;
    }
    button:hover {
      background: #6366f1;
    }
    button.secondary {
      background: #111827;
      border-color: #4b5563;
    }
    main {
      max-width: 1100px;
      margin: 1.5rem auto;
      padding: 0 1rem 2rem;
    }
    .card {
      background: #020617;
      border-radius: 0.75rem;
      border: 1px solid #1f2937;
      padding: 1rem 1.25rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.8);
    }
    .card h2 {
      margin-top: 0;
      font-size: 1.1rem;
      margin-bottom: 0.75rem;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }
    label {
      font-size: 0.8rem;
      color: #9ca3af;
      display: block;
      margin-bottom: 0.2rem;
    }
    textarea {
      min-height: 60px;
      resize: vertical;
    }
    .actions-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 0.5rem;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .status {
      font-size: 0.8rem;
      color: #9ca3af;
    }
    .status span {
      font-weight: 500;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    th, td {
      border-bottom: 1px solid #1f2937;
      padding: 0.4rem 0.5rem;
      text-align: left;
    }
    th {
      background: #020617;
      position: sticky;
      top: 54px; /* below header */
      z-index: 5;
    }
    tr:hover td {
      background: #020617;
    }
    .badge {
      padding: 0.15rem 0.45rem;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #111827;
      border: 1px solid #4b5563;
    }
    .badge-admin {
      background: rgba(34, 197, 94, 0.1);
      border-color: #22c55e;
      color: #bbf7d0;
    }
    .badge-staff {
      background: rgba(59, 130, 246, 0.1);
      border-color: #3b82f6;
      color: #bfdbfe;
    }
    .btn-small {
      font-size: 0.75rem;
      padding: 0.25rem 0.45rem;
      margin-right: 0.25rem;
    }
    .danger {
      background: #b91c1c;
      border-color: #b91c1c;
    }
    .danger:hover {
      background: #dc2626;
    }
    .muted {
      color: #9ca3af;
      font-size: 0.8rem;
    }
    @media (max-width: 768px) {
      th:nth-child(1),
      td:nth-child(1) {
        display: none; /* hide ID on small screens */
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Inventory System</h1>
    <div class="role-area">
      <span>Role:</span>
      <select id="role-select">
        <option value="staff">Staff</option>
        <option value="admin">Admin</option>
      </select>
      <input
        type="password"
        id="admin-password"
        placeholder="Admin password"
        style="display:none;"
      />
      <button id="set-role-btn" class="secondary">Set</button>
      <span id="current-role-label" class="badge badge-staff">Staff</span>
    </div>
  </header>

  <main>
    <!-- Add / Edit Item -->
    <section class="card">
      <h2 id="form-title">Add Item</h2>
      <form id="item-form">
        <input type="hidden" id="edit-index" value="" />
        <div class="form-grid">
          <div>
            <label for="item-name">Item Name *</label>
            <input id="item-name" required autocomplete="off" />
          </div>
          <div>
            <label for="item-qty">Quantity *</label>
            <input id="item-qty" type="number" min="0" step="1" required />
          </div>
          <div>
            <label for="item-group">Group</label>
            <input id="item-group" placeholder="e.g. RAW MATERIAL" />
          </div>
          <div>
            <label for="item-addedby">Added By</label>
            <input id="item-addedby" placeholder="staff / admin" />
          </div>
        </div>
        <div>
          <label for="item-details">Details</label>
          <textarea id="item-details" placeholder="Describe item (grade, brand, etc.)"></textarea>
        </div>
        <div class="actions-row">
          <div>
            <button type="submit" id="submit-btn">Save Item</button>
            <button type="button" id="cancel-edit-btn" class="secondary" style="display:none;">
              Cancel Edit
            </button>
          </div>
          <div class="status" id="status-area">
            Status: <span id="status-text">Idle</span>
          </div>
        </div>
      </form>
      <p class="muted">
        • Staff can only <strong>add</strong> items.<br>
        • Admin can <strong>view, edit & delete</strong> items (password protected).
      </p>
    </section>

    <!-- Inventory Table -->
    <section class="card">
      <h2>Inventory Items</h2>
      <div class="muted" id="count-info">Loading...</div>
      <div style="overflow-x: auto; margin-top: 0.5rem;">
        <table id="inventory-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Qty</th>
              <th>Group</th>
              <th>Details</th>
              <th>Added By</th>
              <th>Updated At</th>
              <th id="actions-header">Actions</th>
            </tr>
          </thead>
          <tbody id="inventory-body"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    // ====== CONFIG ======
    const BACKEND_URL = "https://inventory-backend-s4sv.onrender.com/get-token";
    const REPO_OWNER = "unique205";
    const REPO_NAME = "inventory-data";
    const FILE_PATH = "data/inventory.json";
    const BRANCH = "main";
    const ADMIN_PASSWORD = "admin123"; // change this to your secret

    // ====== STATE ======
    let currentRole = "staff";
    let inventory = [];
    let currentSha = null;

    // ====== DOM ELEMENTS ======
    const roleSelect = document.getElementById("role-select");
    const adminPasswordInput = document.getElementById("admin-password");
    const setRoleBtn = document.getElementById("set-role-btn");
    const currentRoleLabel = document.getElementById("current-role-label");

    const itemForm = document.getElementById("item-form");
    const editIndexInput = document.getElementById("edit-index");
    const itemNameInput = document.getElementById("item-name");
    const itemQtyInput = document.getElementById("item-qty");
    const itemGroupInput = document.getElementById("item-group");
    const itemAddedByInput = document.getElementById("item-addedby");
    const itemDetailsInput = document.getElementById("item-details");
    const submitBtn = document.getElementById("submit-btn");
    const cancelEditBtn = document.getElementById("cancel-edit-btn");
    const formTitle = document.getElementById("form-title");

    const statusText = document.getElementById("status-text");
    const countInfo = document.getElementById("count-info");
    const inventoryBody = document.getElementById("inventory-body");
    const actionsHeader = document.getElementById("actions-header");

    // ====== UTILS ======
    function setStatus(msg) {
      statusText.textContent = msg;
    }

    function generateId() {
      const ts = Date.now();
      const rand = Math.random().toString(36).substring(2, 8);
      return `item_${ts}_${rand}`;
    }

    function formatDate(iso) {
      if (!iso) return "-";
      try {
        const d = new Date(iso);
        return d.toLocaleString();
      } catch {
        return iso;
      }
    }

    async function getBackendToken() {
      const res = await fetch(BACKEND_URL, { method: "POST" });
      if (!res.ok) throw new Error("Backend token request failed");
      const data = await res.json();
      if (!data.token) throw new Error("Backend did not return token");
      return data.token;
    }

    async function githubRequest(path, options = {}) {
      const token = await getBackendToken();

      const res = await fetch(`https://api.github.com${path}`, {
        ...options,
        headers: {
          "Authorization": `Bearer ${token}`,
          "Accept": "application/vnd.github+json",
          "Content-Type": "application/json",
          ...(options.headers || {})
        }
      });

      if (!res.ok) {
        const text = await res.text();
        throw new Error(`GitHub error ${res.status}: ${text}`);
      }
      return res.json();
    }

    // ====== LOAD INVENTORY ======
    async function loadInventory() {
      try {
        setStatus("Loading from GitHub…");

        const data = await githubRequest(
          `/repos/${REPO_OWNER}/${REPO_NAME}/contents/${encodeURIComponent(FILE_PATH)}?ref=${BRANCH}`
        );

        currentSha = data.sha;
        const decoded = atob(data.content.replace(/\n/g, ""));
        inventory = decoded.trim() ? JSON.parse(decoded) : [];

        renderInventory();
        setStatus("Loaded");
      } catch (err) {
        console.error("Error loading inventory:", err);
        if (err.message.includes("404")) {
          inventory = [];
          currentSha = null;
          renderInventory();
          setStatus("File not found, starting empty");
        } else {
          setStatus("Error loading inventory");
          alert("Error loading inventory: " + err.message);
        }
      }
    }

    // ====== SAVE INVENTORY ======
    async function saveInventory() {
      const content = btoa(JSON.stringify(inventory, null, 2));

      const body = {
        message: "Update inventory.json from inventory-app",
        content,
        branch: BRANCH
      };
      if (currentSha) body.sha = currentSha;

      const data = await githubRequest(
        `/repos/${REPO_OWNER}/${REPO_NAME}/contents/${encodeURIComponent(FILE_PATH)}`,
        {
          method: "PUT",
          body: JSON.stringify(body)
        }
      );

      currentSha = data.content.sha;
    }

    // ====== RENDER INVENTORY TABLE ======
    function renderInventory() {
      inventoryBody.innerHTML = "";

      countInfo.textContent = inventory.length
        ? `${inventory.length} items`
        : "No items yet";

      inventory.forEach((item, index) => {
        const tr = document.createElement("tr");

        const tdId = document.createElement("td");
        tdId.textContent = item.id || "-";
        tr.appendChild(tdId);

        const tdName = document.createElement("td");
        tdName.textContent = item.name || "";
        tr.appendChild(tdName);

        const tdQty = document.createElement("td");
        tdQty.textContent = item.quantity ?? "";
        tr.appendChild(tdQty);

        const tdGroup = document.createElement("td");
        tdGroup.textContent = item.group || "";
        tr.appendChild(tdGroup);

        const tdDetails = document.createElement("td");
        tdDetails.textContent = item.details || "";
        tr.appendChild(tdDetails);

        const tdAdded = document.createElement("td");
        tdAdded.textContent = item.addedBy || "";
        tr.appendChild(tdAdded);

        const tdUpdated = document.createElement("td");
        tdUpdated.textContent = formatDate(item.updatedAt || item.timestamp);
        tr.appendChild(tdUpdated);

        const tdActions = document.createElement("td");
        if (currentRole === "admin") {
          const editBtn = document.createElement("button");
          editBtn.textContent = "Edit";
          editBtn.className = "btn-small";
          editBtn.addEventListener("click", () => startEditItem(index));
          tdActions.appendChild(editBtn);

          const delBtn = document.createElement("button");
          delBtn.textContent = "Delete";
          delBtn.className = "btn-small danger";
          delBtn.addEventListener("click", () => deleteItem(index));
          tdActions.appendChild(delBtn);
        } else {
          tdActions.textContent = "-";
          tdActions.className = "muted";
        }

        tr.appendChild(tdActions);
        inventoryBody.appendChild(tr);
      });
    }

    // ====== ROLE HANDLING ======
    function updateRoleDisplay() {
      if (currentRole === "admin") {
        currentRoleLabel.textContent = "Admin";
        currentRoleLabel.className = "badge badge-admin";
      } else {
        currentRoleLabel.textContent = "Staff";
        currentRoleLabel.className = "badge badge-staff";
      }
      renderInventory();
    }

    setRoleBtn.addEventListener("click", () => {
      const selected = roleSelect.value;
      if (selected === "admin") {
        adminPasswordInput.style.display = "inline-block";
        const pwd = adminPasswordInput.value.trim();
        if (!pwd) {
          alert("Enter admin password");
          return;
        }
        if (pwd !== ADMIN_PASSWORD) {
          alert("Wrong password");
          adminPasswordInput.value = "";
          roleSelect.value = "staff";
          currentRole = "staff";
        } else {
          currentRole = "admin";
          adminPasswordInput.value = "";
        }
      } else {
        adminPasswordInput.style.display = "none";
        currentRole = "staff";
      }
      updateRoleDisplay();
    });

    roleSelect.addEventListener("change", () => {
      if (roleSelect.value === "admin") {
        adminPasswordInput.style.display = "inline-block";
      } else {
        adminPasswordInput.style.display = "none";
      }
    });

    // ====== FORM HANDLERS ======
    function resetForm() {
      editIndexInput.value = "";
      itemNameInput.value = "";
      itemQtyInput.value = "";
      itemGroupInput.value = "";
      itemAddedByInput.value = "";
      itemDetailsInput.value = "";
      submitBtn.textContent = "Save Item";
      cancelEditBtn.style.display = "none";
      formTitle.textContent = "Add Item";
    }

    function startEditItem(index) {
      const item = inventory[index];
      editIndexInput.value = index;
      itemNameInput.value = item.name || "";
      itemQtyInput.value = item.quantity ?? "";
      itemGroupInput.value = item.group || "";
      itemAddedByInput.value = item.addedBy || "";
      itemDetailsInput.value = item.details || "";
      submitBtn.textContent = "Update Item";
      cancelEditBtn.style.display = "inline-block";
      formTitle.textContent = "Edit Item";
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    async function deleteItem(index) {
      if (currentRole !== "admin") {
        alert("Only admin can delete items.");
        return;
      }
      const item = inventory[index];
      if (!confirm(`Delete item "${item.name}"?`)) return;

      try {
        setStatus("Deleting item…");
        inventory.splice(index, 1);
        await saveInventory();
        renderInventory();
        setStatus("Item deleted");
      } catch (err) {
        console.error("Delete failed:", err);
        setStatus("Error deleting item");
        alert("Error deleting item: " + err.message);
      }
    }

    itemForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      if (!itemNameInput.value.trim()) {
        alert("Item name is required");
        return;
      }

      const now = new Date().toISOString();
      const index = editIndexInput.value;

      const baseItem = {
        name: itemNameInput.value.trim().toUpperCase(),
        quantity: Number(itemQtyInput.value || 0),
        group: itemGroupInput.value.trim().toUpperCase(),
        details: itemDetailsInput.value.trim(),
        addedBy: itemAddedByInput.value.trim() || currentRole,
      };

      try {
        if (index === "") {
          const newItem = {
            id: generateId(),
            ...baseItem,
            timestamp: now,
            updatedAt: now
          };
          setStatus("Adding item…");
          inventory.push(newItem);
        } else {
          const existing = inventory[Number(index)];
          const updatedItem = {
            ...existing,
            ...baseItem,
            updatedAt: now
          };
          setStatus("Updating item…");
          inventory[Number(index)] = updatedItem;
        }

        await saveInventory();
        renderInventory();
        resetForm();
        setStatus("Saved");
      } catch (err) {
        console.error("Save failed:", err);
        setStatus("Error saving");
        alert("Error saving: " + err.message);
      }
    });

    cancelEditBtn.addEventListener("click", () => resetForm());

    // ====== INIT ======
    (async function init() {
      updateRoleDisplay();
      await loadInventory();
    })();
  </script>
</body>
</html>
