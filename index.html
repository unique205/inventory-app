<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì¶ Inventory System</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üì¶</text></svg>">
    
    <style>
        /* ===== RESET & BASE ===== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8fafc; color: #1e293b; line-height: 1.4; }
        .container { max-width: 1200px; margin: 0 auto; padding: 15px; }
        
        /* ===== HEADER ===== */
        .header { background: white; padding: 15px 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .logo { font-size: 1.8rem; }
        .header-title { font-size: 1.2rem; font-weight: 600; color: #2563eb; }
        .sync-status { display: flex; align-items: center; gap: 10px; }
        .sync-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .sync-online { background: #10b981; color: white; }
        .sync-offline { background: #ef4444; color: white; }
        .sync-pending { background: #f59e0b; color: white; }
        
        /* ===== TABS ===== */
        .tabs { display: flex; gap: 2px; background: #e2e8f0; padding: 2px; border-radius: 8px; margin-bottom: 20px; }
        .tab { flex: 1; padding: 12px; text-align: center; background: white; border: none; font-weight: 600; color: #64748b; cursor: pointer; transition: all 0.3s; }
        .tab:first-child { border-radius: 6px 0 0 6px; }
        .tab:last-child { border-radius: 0 6px 6px 0; }
        .tab.active { background: #2563eb; color: white; }
        
        /* ===== FORMS ===== */
        .card { background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .card-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 20px; color: #1e293b; display: flex; align-items: center; gap: 8px; }
        
        .form-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 15px; }
        .form-group { display: flex; flex-direction: column; }
        .form-label { font-size: 0.75rem; font-weight: 600; color: #64748b; margin-bottom: 6px; text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 10px 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 0.9rem; transition: all 0.2s; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        #nameInput, #detailsInput, #groupInput { text-transform: uppercase; }
        
        /* ===== BUTTONS ===== */
        .btn { padding: 10px 20px; border: none; border-radius: 6px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: #2563eb; color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #0da271; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-warning:hover { background: #d97706; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-secondary { background: #64748b; color: white; }
        .btn-secondary:hover { background: #475569; }
        
        .btn-small { padding: 6px 12px; font-size: 0.8rem; }
        .btn-wide { width: 100%; justify-content: center; }
        
        /* ===== TABLES ===== */
        .table-container { overflow-x: auto; }
        .table { width: 100%; border-collapse: collapse; }
        .table th { background: #f1f5f9; padding: 12px 15px; text-align: left; font-weight: 600; font-size: 0.75rem; color: #64748b; text-transform: uppercase; border-bottom: 2px solid #e2e8f0; }
        .table td { padding: 12px 15px; border-bottom: 1px solid #e2e8f0; vertical-align: middle; }
        .table tr:hover { background: #f8fafc; }
        .table tr.pending { background: #fffbeb; }
        .table tr.approved { background: #f0fdf4; }
        
        .item-name { font-weight: 600; color: #1e293b; text-transform: uppercase; }
        .item-quantity { font-weight: 700; color: #2563eb; }
        .item-group { background: #e0f2fe; color: #0369a1; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; display: inline-block; }
        
        .action-buttons { display: flex; gap: 5px; }
        .action-btn { padding: 4px 8px; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer; }
        .edit-btn { background: #f59e0b; color: white; }
        .delete-btn { background: #ef4444; color: white; }
        .approve-btn { background: #10b981; color: white; }
        .reject-btn { background: #ef4444; color: white; }
        
        /* ===== BATCH SYSTEM ===== */
        .batch-section { background: #f0fdf4; border: 2px dashed #10b981; border-radius: 10px; padding: 20px; margin-bottom: 20px; }
        .batch-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .batch-actions { display: flex; gap: 10px; }
        
        /* ===== STATUS BADGES ===== */
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; display: inline-block; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-approved { background: #d1fae5; color: #065f46; }
        .status-rejected { background: #fee2e2; color: #991b1b; }
        
        /* ===== MODALS ===== */
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; display: none; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 10px; padding: 25px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 15px; color: #1e293b; }
        .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        
        /* ===== SETUP FORM ===== */
        .setup-form { max-width: 500px; margin: 40px auto; }
        .setup-form input { margin-bottom: 15px; }
        .step { margin-bottom: 25px; }
        .step-number { display: inline-block; background: #2563eb; color: white; width: 24px; height: 24px; border-radius: 50%; text-align: center; line-height: 24px; margin-right: 10px; }
        
        /* ===== UTILITY ===== */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .mt-10 { margin-top: 10px; }
        .mt-20 { margin-top: 20px; }
        .mb-10 { margin-bottom: 10px; }
        .mb-20 { margin-bottom: 20px; }
        
        /* ===== RESPONSIVE ===== */
        @media (max-width: 1024px) {
            .form-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
            .header { flex-direction: column; gap: 15px; align-items: stretch; }
            .table { font-size: 0.85rem; }
            .table th, .table td { padding: 8px 10px; }
        }
    </style>
</head>
<body>
    <!-- SETUP MODAL -->
    <div id="setupModal" class="modal active">
        <div class="modal-content">
            <div class="modal-title">üîß Setup Required</div>
            
            <div class="setup-form">
                <div class="step">
                    <div class="step-number">1</div>
                    <strong>GitHub Repository</strong>
                    <p style="font-size: 0.9rem; color: #64748b; margin: 5px 0 10px 34px;">
                        Make sure you have created: <br>
                        ‚Ä¢ <strong>inventory-data</strong> repository (Public)<br>
                        ‚Ä¢ With file: <code>data/inventory.json</code>
                    </p>
                </div>
                
                <div class="step">
                    <div class="step-number">2</div>
                    <strong>GitHub Token</strong>
                    <p style="font-size: 0.9rem; color: #64748b; margin: 5px 0 10px 34px;">
                        <a href="https://github.com/settings/tokens" target="_blank" style="color: #2563eb;">Create token here</a><br>
                        ‚Ä¢ Click "Generate new token"<br>
                        ‚Ä¢ Select only <strong>inventory-data</strong> repository<br>
                        ‚Ä¢ Permissions: <strong>Contents: Read and write</strong>
                    </p>
                    <input type="text" id="githubTokenInput" placeholder="Paste your GitHub token here" style="margin-left: 34px;">
                </div>
                
                <div class="step">
                    <div class="step-number">3</div>
                    <strong>Login</strong>
                    <div style="margin-left: 34px;">
                        <input type="password" id="loginPassword" placeholder="Admin password (leave empty for staff)">
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button id="staffLoginBtn" class="btn btn-secondary">Staff Login</button>
                            <button id="adminLoginBtn" class="btn btn-primary">Admin Login</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button id="skipSyncBtn" class="btn btn-secondary">Skip Sync (Local Only)</button>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div class="container" id="mainApp" style="display: none;">
        <!-- HEADER -->
        <div class="header">
            <div class="header-left">
                <div class="logo">üì¶</div>
                <div class="header-title">INVENTORY SYSTEM - REAL TIME SYNC</div>
            </div>
            <div class="sync-status">
                <span id="syncStatus" class="sync-badge sync-online">üîÑ Synced</span>
                <span class="user-badge" id="userRole">Staff</span>
                <button id="logoutBtn" class="btn btn-small btn-secondary">Logout</button>
            </div>
        </div>

        <!-- TABS -->
        <div class="tabs">
            <button class="tab active" data-tab="add">‚ûï Add Items</button>
            <button class="tab" data-tab="pending">‚è≥ Pending Approval</button>
            <button class="tab" data-tab="inventory">üìã Inventory</button>
            <button class="tab" data-tab="activity" id="activityTab">üìä Activity</button>
        </div>

        <!-- ADD ITEMS TAB -->
        <div id="addTab" class="tab-content">
            <div class="card">
                <div class="card-title">‚ûï ADD NEW ITEMS (Auto-saves to cloud)</div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Item Name</label>
                        <input type="text" id="nameInput" placeholder="ITEM NAME" autocapitalize="characters">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Quantity</label>
                        <input type="number" id="quantityInput" placeholder="0" min="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Group</label>
                        <input type="text" id="groupInput" placeholder="RAW MATERIAL, TOOLS, etc" autocapitalize="characters">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Details</label>
                        <input type="text" id="detailsInput" placeholder="Details (Optional)" autocapitalize="characters">
                    </div>
                </div>
                <button id="addItemBtn" class="btn btn-primary btn-wide">‚ûï ADD TO BATCH</button>
                <p class="text-center mt-10" style="color: #64748b; font-size: 0.85rem;">
                    Items auto-save to cloud. Admin can approve from anywhere.
                </p>
            </div>

            <!-- CURRENT BATCH -->
            <div class="batch-section">
                <div class="batch-header">
                    <div class="card-title">üì¶ CURRENT BATCH (Auto-syncing)</div>
                    <div class="batch-actions">
                        <button id="clearBatchBtn" class="btn btn-danger btn-small">üóëÔ∏è Clear</button>
                        <button id="submitBatchBtn" class="btn btn-success btn-small">üì§ Submit Now</button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="table" id="batchTable">
                        <thead>
                            <tr>
                                <th width="30%">Item Name</th>
                                <th width="15%">Quantity</th>
                                <th width="20%">Group</th>
                                <th width="25%">Details</th>
                                <th width="10%">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="batchItems">
                            <!-- Batch items will appear here -->
                        </tbody>
                    </table>
                </div>
                <div class="text-right mt-10">
                    <span id="batchCount">0 items ‚Ä¢ Auto-syncing to cloud</span>
                </div>
            </div>
        </div>

        <!-- PENDING BATCH TAB -->
        <div id="pendingTab" class="tab-content hidden">
            <div class="card">
                <div class="card-title">‚è≥ PENDING ITEMS (From all locations)</div>
                <div class="table-container">
                    <table class="table" id="pendingTable">
                        <thead>
                            <tr>
                                <th width="25%">Item Name</th>
                                <th width="10%">Qty</th>
                                <th width="15%">Group</th>
                                <th width="20%">Details</th>
                                <th width="15%">Added By</th>
                                <th width="15%">Status</th>
                            </tr>
                        </thead>
                        <tbody id="pendingItems">
                            <!-- Pending items will appear here -->
                        </tbody>
                    </table>
                </div>
                <div id="adminBatchActions" class="hidden mt-20">
                    <div class="card-title">üëë ADMIN ACTIONS</div>
                    <div style="display: flex; gap: 10px;">
                        <button id="approveAllBtn" class="btn btn-success">‚úÖ Approve All</button>
                        <button id="rejectAllBtn" class="btn btn-danger">‚ùå Reject All</button>
                        <button id="refreshBtn" class="btn btn-secondary">üîÑ Refresh</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- INVENTORY TAB -->
        <div id="inventoryTab" class="tab-content hidden">
            <div class="card">
                <div class="card-title">üìã LIVE INVENTORY (Cloud Synced)</div>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="searchInput" placeholder="üîç Search items..." style="flex: 1;">
                    <select id="filterGroup">
                        <option value="">All Groups</option>
                    </select>
                    <button id="refreshInventoryBtn" class="btn btn-secondary">üîÑ Refresh</button>
                </div>
                <div class="table-container">
                    <table class="table" id="inventoryTable">
                        <thead>
                            <tr>
                                <th width="25%">Item Name</th>
                                <th width="10%">Qty</th>
                                <th width="15%">Group</th>
                                <th width="30%">Details</th>
                                <th width="20%">Last Updated</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryItems">
                            <!-- Inventory items will appear here -->
                        </tbody>
                    </table>
                </div>
                <div class="text-right mt-10">
                    <span id="inventoryCount">0 items ‚Ä¢ Synced from cloud</span>
                </div>
            </div>
        </div>

        <!-- ACTIVITY TAB -->
        <div id="activityTabContent" class="tab-content hidden">
            <div class="card">
                <div class="card-title">üìä SYSTEM ACTIVITY</div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th width="20%">Time</th>
                                <th width="30%">Action</th>
                                <th width="25%">Item</th>
                                <th width="25%">User</th>
                            </tr>
                        </thead>
                        <tbody id="activityLog">
                            <tr><td colspan="4" class="text-center">Loading activity...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- DELETE MODAL -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">‚ö†Ô∏è Confirm Delete</div>
            <p id="deleteMessage">Are you sure you want to delete this item?</p>
            <div class="modal-buttons">
                <button id="cancelDeleteBtn" class="btn btn-secondary">Cancel</button>
                <button id="confirmDeleteBtn" class="btn btn-danger">Delete</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const CONFIG = {
            ADMIN_PASSWORD: 'Arshiyan2@',
            GITHUB_USERNAME: 'unique205',
            DATA_REPO: 'inventory-data',
            DATA_FILE: 'data/inventory.json',
            BRANCH: 'main',
            SYNC_INTERVAL: 10000, // Sync every 10 seconds
            MAX_RETRIES: 3
        };

        // ============================================
        // APPLICATION STATE
        // ============================================
        let currentUser = null; // 'staff' or 'admin'
        let currentBatch = []; // Items staff is adding (local)
        let pendingItems = []; // Items waiting approval (cloud)
        let inventory = []; // Approved items (cloud)
        let activityLog = []; // System activity
        let githubToken = null;
        let isOnline = navigator.onLine;
        let syncInProgress = false;
        let syncInterval = null;
        let lastSyncTime = null;

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Inventory System Loading...');
            
            // Load local data
            loadLocalData();
            
            // Setup event listeners
            setupEventListeners();
            
            // Start sync if token exists
            if (githubToken) {
                startAutoSync();
            }
        });

        // ============================================
        // DATA MANAGEMENT
        // ============================================
        function loadLocalData() {
            // Load GitHub token
            githubToken = localStorage.getItem('github_token');
            
            // Load current batch
            const savedBatch = localStorage.getItem('current_batch');
            if (savedBatch) {
                try {
                    currentBatch = JSON.parse(savedBatch);
                } catch (e) {
                    currentBatch = [];
                }
            }
            
            // Load user session
            const savedUser = localStorage.getItem('current_user');
            if (savedUser) {
                currentUser = savedUser;
                showMainApp();
            }
            
            // Load activity log
            const savedActivity = localStorage.getItem('activity_log');
            if (savedActivity) {
                try {
                    activityLog = JSON.parse(savedActivity);
                } catch (e) {
                    activityLog = [];
                }
            }
        }

        function saveLocalData() {
            localStorage.setItem('current_batch', JSON.stringify(currentBatch));
            localStorage.setItem('activity_log', JSON.stringify(activityLog));
            if (githubToken) {
                localStorage.setItem('github_token', githubToken);
            }
            if (currentUser) {
                localStorage.setItem('current_user', currentUser);
            }
        }

        function addActivity(action, itemName, details = '') {
            const activity = {
                id: 'act_' + Date.now(),
                timestamp: new Date().toISOString(),
                user: currentUser || 'unknown',
                action: action,
                item: itemName,
                details: details
            };
            
            activityLog.unshift(activity); // Add to beginning
            if (activityLog.length > 100) {
                activityLog = activityLog.slice(0, 100); // Keep only last 100
            }
            
            saveLocalData();
            updateActivityLog();
        }

        // ============================================
        // CLOUD SYNC FUNCTIONS (REAL-TIME)
        // ============================================
        async function startAutoSync() {
            if (!githubToken) return;
            
            // Initial sync
            await syncAllData();
            
            // Set up periodic sync
            syncInterval = setInterval(async () => {
                if (isOnline && !syncInProgress) {
                    await syncAllData();
                }
            }, CONFIG.SYNC_INTERVAL);
            
            // Also sync when coming online
            window.addEventListener('online', async () => {
                isOnline = true;
                updateSyncStatus('üîÑ Syncing...', 'pending');
                await syncAllData();
            });
        }

        async function syncAllData() {
            if (!isOnline || !githubToken || syncInProgress) return;
            
            syncInProgress = true;
            updateSyncStatus('üîÑ Syncing...', 'pending');
            
            try {
                console.log('üîÑ Starting cloud sync...');
                
                // 1. Push local batch to cloud (if staff)
                if (currentUser === 'staff' && currentBatch.length > 0) {
                    await pushBatchToCloud();
                }
                
                // 2. Pull latest data from cloud
                await pullFromCloud();
                
                // 3. Update UI
                updateAllTables();
                
                // 4. Update sync status
                lastSyncTime = new Date();
                updateSyncStatus(`‚úÖ Synced ${formatTime(lastSyncTime)}`, 'online');
                
                console.log('‚úÖ Cloud sync completed');
                
            } catch (error) {
                console.error('‚ùå Sync failed:', error);
                updateSyncStatus('‚ùå Sync failed', 'offline');
            } finally {
                syncInProgress = false;
            }
        }

        async function pushBatchToCloud() {
            if (currentBatch.length === 0) return;
            
            // Read existing pending items
            let cloudPending = await readPendingFromCloud();
            
            // Add local batch items
            currentBatch.forEach(item => {
                // Check if item already exists
                const exists = cloudPending.some(pending => 
                    pending.name === item.name && 
                    pending.group === item.group &&
                    pending.status === 'pending'
                );
                
                if (!exists) {
                    cloudPending.push({
                        ...item,
                        addedBy: 'Staff (' + (navigator.userAgent.match(/Mobile/) ? 'Mobile' : 'Desktop') + ')',
                        addedAt: new Date().toISOString(),
                        location: getLocationFromIP(),
                        status: 'pending',
                        synced: true
                    });
                }
            });
            
            // Write back to cloud
            await writePendingToCloud(cloudPending);
            
            // Clear local batch after successful sync
            currentBatch = [];
            saveLocalData();
            updateBatchTable();
            
            addActivity('BATCH_SUBMITTED', `${currentBatch.length} items`, 'Submitted to cloud');
        }

        async function pullFromCloud() {
            // Pull both pending items and inventory
            const [cloudPending, cloudInventory] = await Promise.all([
                readPendingFromCloud(),
                readInventoryFromCloud()
            ]);
            
            // Update local state
            pendingItems = cloudPending;
            inventory = cloudInventory;
            
            // Update UI
            updatePendingTable();
            updateInventoryTable();
            updateGroupsFilter();
            
            addActivity('DATA_PULLED', 'Cloud data', `Pending: ${pendingItems.length}, Inventory: ${inventory.length}`);
        }

        async function readPendingFromCloud() {
            const url = `https://api.github.com/repos/${CONFIG.GITHUB_USERNAME}/${CONFIG.DATA_REPO}/contents/pending.json`;
            
            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.status === 404) {
                    return []; // File doesn't exist yet
                }
                
                if (!response.ok) {
                    throw new Error(`GitHub error: ${response.status}`);
                }
                
                const data = await response.json();
                const content = atob(data.content.replace(/\n/g, ''));
                return JSON.parse(content);
            } catch (error) {
                console.error('Failed to read pending:', error);
                return [];
            }
        }

        async function readInventoryFromCloud() {
            const url = `https://api.github.com/repos/${CONFIG.GITHUB_USERNAME}/${CONFIG.DATA_REPO}/contents/${CONFIG.DATA_FILE}`;
            
            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.status === 404) {
                    return []; // File doesn't exist yet
                }
                
                if (!response.ok) {
                    throw new Error(`GitHub error: ${response.status}`);
                }
                
                const data = await response.json();
                const content = atob(data.content.replace(/\n/g, ''));
                return JSON.parse(content);
            } catch (error) {
                console.error('Failed to read inventory:', error);
                return [];
            }
        }

        async function writePendingToCloud(data) {
            const url = `https://api.github.com/repos/${CONFIG.GITHUB_USERNAME}/${CONFIG.DATA_REPO}/contents/pending.json`;
            
            // Get current SHA if file exists
            let sha = null;
            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                if (response.ok) {
                    const info = await response.json();
                    sha = info.sha;
                }
            } catch (e) {
                // File doesn't exist
            }
            
            const content = btoa(JSON.stringify(data, null, 2));
            const body = {
                message: `Pending items update ${new Date().toLocaleString()}`,
                content: content,
                branch: CONFIG.BRANCH
            };
            
            if (sha) {
                body.sha = sha;
            }
            
            const response = await fetch(url, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });
            
            if (!response.ok) {
                throw new Error(`GitHub write error: ${response.status}`);
            }
            
            return await response.json();
        }

        async function writeInventoryToCloud(data) {
            const url = `https://api.github.com/repos/${CONFIG.GITHUB_USERNAME}/${CONFIG.DATA_REPO}/contents/${CONFIG.DATA_FILE}`;
            
            // Get current SHA if file exists
            let sha = null;
            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                if (response.ok) {
                    const info = await response.json();
                    sha = info.sha;
                }
            } catch (e) {
                // File doesn't exist
            }
            
            const content = btoa(JSON.stringify(data, null, 2));
            const body = {
                message: `Inventory update ${new Date().toLocaleString()}`,
                content: content,
                branch: CONFIG.BRANCH
            };
            
            if (sha) {
                body.sha = sha;
            }
            
            const response = await fetch(url, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });
            
            if (!response.ok) {
                throw new Error(`GitHub write error: ${response.status}`);
            }
            
            return await response.json();
        }

        // ============================================
        // USER MANAGEMENT
        // ============================================
        function loginAsStaff() {
            currentUser = 'staff';
            localStorage.setItem('current_user', 'staff');
            showMainApp();
            showMessage('‚úÖ Logged in as Staff');
            addActivity('LOGIN', 'Staff login');
        }

        function loginAsAdmin(password) {
            if (password === CONFIG.ADMIN_PASSWORD) {
                currentUser = 'admin';
                localStorage.setItem('current_user', 'admin');
                showMainApp();
                showMessage('‚úÖ Logged in as Admin');
                addActivity('LOGIN', 'Admin login');
                return true;
            } else {
                showMessage('‚ùå Incorrect admin password');
                return false;
            }
        }

        function logout() {
            addActivity('LOGOUT', `${currentUser} logout`);
            currentUser = null;
            localStorage.removeItem('current_user');
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('setupModal').classList.add('active');
            showMessage('Logged out successfully');
            
            // Stop auto-sync
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
            }
        }

        function showMainApp() {
            document.getElementById('setupModal').classList.remove('active');
            document.getElementById('mainApp').style.display = 'block';
            
            // Update UI based on user role
            document.getElementById('userRole').textContent = currentUser === 'admin' ? 'Admin' : 'Staff';
            
            // Show/hide admin features
            document.getElementById('adminBatchActions').classList.toggle('hidden', currentUser !== 'admin');
            document.getElementById('activityTab').classList.toggle('hidden', currentUser !== 'admin');
            
            // Start auto-sync if token exists
            if (githubToken && !syncInterval) {
                startAutoSync();
            }
            
            // Update all tables
            updateAllTables();
        }

        // ============================================
        // BATCH MANAGEMENT (STAFF)
        // ============================================
        function addItemToBatch() {
            const name = document.getElementById('nameInput').value.trim().toUpperCase();
            const quantity = parseInt(document.getElementById('quantityInput').value);
            const group = document.getElementById('groupInput').value.trim().toUpperCase();
            const details = document.getElementById('detailsInput').value.trim().toUpperCase();
            
            // Validation
            if (!name) {
                showMessage('‚ùå Please enter item name');
                return;
            }
            if (!quantity || quantity < 1) {
                showMessage('‚ùå Please enter valid quantity');
                return;
            }
            if (!group) {
                showMessage('‚ùå Please enter group');
                return;
            }
            
            // Create item
            const newItem = {
                id: 'item_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                name: name,
                quantity: quantity,
                group: group,
                details: details,
                addedAt: new Date().toISOString(),
                status: 'pending',
                synced: false
            };
            
            // Add to batch
            currentBatch.push(newItem);
            
            // Clear form
            document.getElementById('nameInput').value = '';
            document.getElementById('quantityInput').value = '';
            document.getElementById('groupInput').value = '';
            document.getElementById('detailsInput').value = '';
            document.getElementById('nameInput').focus();
            
            // Save and update
            saveLocalData();
            updateBatchTable();
            updateCounts();
            
            // Auto-sync if online
            if (isOnline && githubToken) {
                setTimeout(() => syncAllData(), 1000);
            }
            
            addActivity('ITEM_ADDED', name, `Qty: ${quantity}, Group: ${group}`);
            showMessage('‚úÖ Item added to batch (Auto-syncing...)');
        }

        function removeFromBatch(itemId) {
            const itemIndex = currentBatch.findIndex(item => item.id === itemId);
            if (itemIndex === -1) return;
            
            const item = currentBatch[itemIndex];
            currentBatch.splice(itemIndex, 1);
            
            saveLocalData();
            updateBatchTable();
            updateCounts();
            
            addActivity('ITEM_REMOVED', item.name, 'From local batch');
            showMessage('‚úÖ Item removed from batch');
        }

        function clearBatch() {
            if (currentBatch.length === 0) {
                showMessage('‚ö†Ô∏è Batch is already empty');
                return;
            }
            
            if (confirm('Clear all items from current batch?')) {
                addActivity('BATCH_CLEARED', `${currentBatch.length} items`);
                currentBatch = [];
                saveLocalData();
                updateBatchTable();
                updateCounts();
                showMessage('‚úÖ Batch cleared');
            }
        }

        // ============================================
        // APPROVAL SYSTEM (ADMIN)
        // ============================================
        async function approveItem(itemId) {
            const itemIndex = pendingItems.findIndex(item => item.id === itemId);
            if (itemIndex === -1) return;
            
            const item = pendingItems[itemIndex];
            
            // Remove from pending
            pendingItems.splice(itemIndex, 1);
            
            // Add to inventory
            const existingIndex = inventory.findIndex(invItem => 
                invItem.name === item.name && invItem.group === item.group
            );
            
            if (existingIndex !== -1) {
                // Update quantity
                inventory[existingIndex].quantity += item.quantity;
                inventory[existingIndex].updatedAt = new Date().toISOString();
                inventory[existingIndex].lastUpdatedBy = 'Admin';
            } else {
                // Add new item
                inventory.unshift({
                    ...item,
                    status: 'approved',
                    approvedAt: new Date().toISOString(),
                    approvedBy: 'Admin'
                });
            }
            
            // Update cloud
            await writePendingToCloud(pendingItems);
            await writeInventoryToCloud(inventory);
            
            // Update UI
            updatePendingTable();
            updateInventoryTable();
            updateCounts();
            
            addActivity('ITEM_APPROVED', item.name, `Qty: ${item.quantity}`);
            showMessage('‚úÖ Item approved and added to inventory');
        }

        async function rejectItem(itemId) {
            const itemIndex = pendingItems.findIndex(item => item.id === itemId);
            if (itemIndex === -1) return;
            
            const item = pendingItems[itemIndex];
            
            // Remove from pending
            pendingItems.splice(itemIndex, 1);
            
            // Update cloud
            await writePendingToCloud(pendingItems);
            
            // Update UI
            updatePendingTable();
            updateCounts();
            
            addActivity('ITEM_REJECTED', item.name, `Qty: ${item.quantity}`);
            showMessage('‚úÖ Item rejected');
        }

        async function approveAllPending() {
            if (pendingItems.length === 0) {
                showMessage('‚ùå No pending items to approve');
                return;
            }
            
            if (!confirm(`Approve all ${pendingItems.length} pending items?`)) {
                return;
            }
            
            // Process each item
            pendingItems.forEach(item => {
                const existingIndex = inventory.findIndex(invItem => 
                    invItem.name === item.name && invItem.group === item.group
                );
                
                if (existingIndex !== -1) {
                    inventory[existingIndex].quantity += item.quantity;
                    inventory[existingIndex].updatedAt = new Date().toISOString();
                } else {
                    inventory.unshift({
                        ...item,
                        status: 'approved',
                        approvedAt: new Date().toISOString(),
                        approvedBy: 'Admin'
                    });
                }
            });
            
            // Clear pending
            pendingItems = [];
            
            // Update cloud
            await writePendingToCloud(pendingItems);
            await writeInventoryToCloud(inventory);
            
            // Update UI
            updatePendingTable();
            updateInventoryTable();
            updateCounts();
            
            addActivity('ALL_APPROVED', `${inventory.length} items`);
            showMessage(`‚úÖ All items approved and added to inventory`);
        }

        async function rejectAllPending() {
            if (pendingItems.length === 0) {
                showMessage('‚ùå No pending items to reject');
                return;
            }
            
            if (!confirm(`Reject all ${pendingItems.length} pending items?`)) {
                return;
            }
            
            addActivity('ALL_REJECTED', `${pendingItems.length} items`);
            pendingItems = [];
            
            // Update cloud
            await writePendingToCloud(pendingItems);
            
            // Update UI
            updatePendingTable();
            updateCounts();
            
            showMessage('‚úÖ All pending items rejected');
        }

        // ============================================
        // UI UPDATES
        // ============================================
        function updateAllTables() {
            updateBatchTable();
            updatePendingTable();
            updateInventoryTable();
            updateCounts();
            updateGroupsFilter();
            updateActivityLog();
        }

        function updateBatchTable() {
            const tbody = document.getElementById('batchItems');
            
            if (currentBatch.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center" style="padding: 40px; color: #64748b;">
                            No items in current batch. Add items above.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = currentBatch.map(item => `
                <tr class="pending">
                    <td class="item-name">${item.name}</td>
                    <td class="item-quantity">${item.quantity}</td>
                    <td><span class="item-group">${item.group}</span></td>
                    <td>${item.details || '-'}</td>
                    <td>
                        <div class="action-buttons">
                            <button onclick="removeFromBatch('${item.id}')" class="action-btn delete-btn" title="Remove">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function updatePendingTable() {
            const tbody = document.getElementById('pendingItems');
            
            if (pendingItems.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center" style="padding: 40px; color: #64748b;">
                            No pending items for approval.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = pendingItems.map(item => `
                <tr class="pending">
                    <td class="item-name">${item.name}</td>
                    <td class="item-quantity">${item.quantity}</td>
                    <td><span class="item-group">${item.group}</span></td>
                    <td>${item.details || '-'}</td>
                    <td>${item.addedBy || 'Staff'}</td>
                    <td>
                        ${currentUser === 'admin' ? `
                            <div class="action-buttons">
                                <button onclick="approveItem('${item.id}')" class="action-btn approve-btn" title="Approve">‚úÖ</button>
                                <button onclick="rejectItem('${item.id}')" class="action-btn reject-btn" title="Reject">‚ùå</button>
                            </div>
                        ` : `
                            <span class="status-badge status-pending">Waiting Approval</span>
                        `}
                    </td>
                </tr>
            `).join('');
        }

        function updateInventoryTable() {
            const tbody = document.getElementById('inventoryItems');
            
            if (inventory.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center" style="padding: 40px; color: #64748b;">
                            No items in inventory yet.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = inventory.map(item => `
                <tr class="approved">
                    <td class="item-name">${item.name}</td>
                    <td class="item-quantity">${item.quantity}</td>
                    <td><span class="item-group">${item.group}</span></td>
                    <td>${item.details || '-'}</td>
                    <td style="font-size: 0.8rem; color: #64748b;">
                        ${formatTime(item.updatedAt || item.approvedAt || item.addedAt)}
                    </td>
                </tr>
            `).join('');
        }

        function updateActivityLog() {
            const tbody = document.getElementById('activityLog');
            
            if (activityLog.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center" style="padding: 40px; color: #64748b;">
                            No activity recorded yet.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = activityLog.slice(0, 20).map(activity => `
                <tr>
                    <td style="font-size: 0.8rem; color: #64748b;">
                        ${formatTime(activity.timestamp)}
                    </td>
                    <td>
                        <span style="font-weight: 600; color: #1e293b;">${activity.action}</span>
                        <br>
                        <span style="font-size: 0.75rem; color: #64748b;">${activity.details}</span>
                    </td>
                    <td>${activity.item}</td>
                    <td>
                        <span class="user-badge">${activity.user}</span>
                    </td>
                </tr>
            `).join('');
        }

        function updateGroupsFilter() {
            const select = document.getElementById('filterGroup');
            const groups = new Set();
            
            inventory.forEach(item => groups.add(item.group));
            pendingItems.forEach(item => groups.add(item.group));
            currentBatch.forEach(item => groups.add(item.group));
            
            select.innerHTML = '<option value="">All Groups</option>';
            Array.from(groups).sort().forEach(group => {
                if (group) {
                    select.innerHTML += `<option value="${group}">${group}</option>`;
                }
            });
        }

        function updateCounts() {
            document.getElementById('batchCount').textContent = 
                `${currentBatch.length} items in batch ‚Ä¢ ${pendingItems.length} pending approval`;
            document.getElementById('inventoryCount').textContent = 
                `${inventory.length} items in inventory ‚Ä¢ Last sync: ${lastSyncTime ? formatTime(lastSyncTime) : 'Never'}`;
        }

        function updateSyncStatus(text, status) {
            const element = document.getElementById('syncStatus');
            element.textContent = text;
            element.className = 'sync-badge ' + 
                (status === 'online' ? 'sync-online' : 
                 status === 'offline' ? 'sync-offline' : 'sync-pending');
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function formatTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffMins < 1440) return `${Math.floor(diffMins / 60)}h ago`;
            return date.toLocaleDateString();
        }

        function getLocationFromIP() {
            // Simple location detection based on timezone
            const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            if (timezone.includes('India')) return 'Pusad';
            if (timezone.includes('London')) return 'London';
            return 'Unknown';
        }

        function showMessage(message) {
            // Remove existing
            const existing = document.querySelector('.message-toast');
            if (existing) existing.remove();
            
            // Create new
            const messageEl = document.createElement('div');
            messageEl.className = 'message-toast';
            messageEl.textContent = message;
            messageEl.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: ${message.includes('‚úÖ') ? '#10b981' : message.includes('‚ùå') ? '#ef4444' : message.includes('‚ö†Ô∏è') ? '#f59e0b' : '#2563eb'};
                color: white;
                padding: 10px 20px;
                border-radius: 6px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1000;
                font-size: 0.9rem;
                animation: slideIn 0.3s ease-out;
            `;
            
            document.body.appendChild(messageEl);
            
            setTimeout(() => {
                if (messageEl.parentNode) {
                    messageEl.style.animation = 'slideOut 0.3s ease-out forwards';
                    setTimeout(() => {
                        if (messageEl.parentNode) {
                            messageEl.parentNode.removeChild(messageEl);
                        }
                    }, 300);
                }
            }, 3000);
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        function setupEventListeners() {
            // Setup buttons
            document.getElementById('staffLoginBtn').addEventListener('click', () => {
                const token = document.getElementById('githubTokenInput').value.trim();
                if (token) {
                    githubToken = token;
                    localStorage.setItem('github_token', token);
                }
                loginAsStaff();
            });
            
            document.getElementById('adminLoginBtn').addEventListener('click', () => {
                const token = document.getElementById('githubTokenInput').value.trim();
                const password = document.getElementById('loginPassword').value;
                
                if (token) {
                    githubToken = token;
                    localStorage.setItem('github_token', token);
                }
                
                loginAsAdmin(password);
            });
            
            document.getElementById('skipSyncBtn').addEventListener('click', () => {
                githubToken = null;
                localStorage.removeItem('github_token');
                loginAsStaff();
                showMessage('‚ö†Ô∏è Using local mode only - No cloud sync');
            });
            
            // Enter key in login
            document.getElementById('loginPassword').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const token = document.getElementById('githubTokenInput').value.trim();
                    const password = document.getElementById('loginPassword').value;
                    
                    if (token) {
                        githubToken = token;
                        localStorage.setItem('github_token', token);
                    }
                    
                    loginAsAdmin(password);
                }
            });
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // Tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const tabName = e.target.dataset.tab;
                    
                    // Hide all tabs
                    document.querySelectorAll('.tab-content').forEach(tab => {
                        tab.classList.add('hidden');
                    });
                    
                    // Remove active class
                    document.querySelectorAll('.tab').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    
                    // Show selected tab
                    document.getElementById(tabName + 'Tab').classList.remove('hidden');
                    e.target.classList.add('active');
                });
            });
            
            // Add item
            document.getElementById('addItemBtn').addEventListener('click', addItemToBatch);
            document.getElementById('nameInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addItemToBatch();
            });
            
            // Batch actions
            document.getElementById('clearBatchBtn').addEventListener('click', clearBatch);
            document.getElementById('submitBatchBtn').addEventListener('click', () => {
                if (currentBatch.length === 0) {
                    showMessage('‚ùå No items in batch to submit');
                    return;
                }
                syncAllData();
                showMessage('‚úÖ Batch submitted for approval');
            });
            
            // Admin actions
            document.getElementById('approveAllBtn').addEventListener('click', approveAllPending);
            document.getElementById('rejectAllBtn').addEventListener('click', rejectAllPending);
            document.getElementById('refreshBtn').addEventListener('click', () => syncAllData());
            document.getElementById('refreshInventoryBtn').addEventListener('click', () => syncAllData());
            
            // Search
            document.getElementById('searchInput').addEventListener('input', () => {
                const searchTerm = document.getElementById('searchInput').value.toUpperCase();
                const filterGroup = document.getElementById('filterGroup').value;
                
                updateInventoryTable(searchTerm, filterGroup);
            });
            
            document.getElementById('filterGroup').addEventListener('change', () => {
                const searchTerm = document.getElementById('searchInput').value.toUpperCase();
                const filterGroup = document.getElementById('filterGroup').value;
                
                updateInventoryTable(searchTerm, filterGroup);
            });
            
            // Online/offline
            window.addEventListener('online', () => {
                isOnline = true;
                updateSyncStatus('üîÑ Coming online...', 'pending');
                setTimeout(() => syncAllData(), 2000);
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                updateSyncStatus('üî¥ Offline', 'offline');
            });
        }

        // Add animation styles
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            .user-badge {
                background: #e0f2fe;
                color: #0369a1;
                padding: 4px 10px;
                border-radius: 20px;
                font-size: 0.75rem;
                font-weight: 600;
                display: inline-block;
            }
        `;
        document.head.appendChild(style);

        // Make functions globally available
        window.removeFromBatch = removeFromBatch;
        window.approveItem = approveItem;
        window.rejectItem = rejectItem;
    </script>
</body>
</html>
