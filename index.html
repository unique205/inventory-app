<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì¶ Inventory System</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üì¶</text></svg>">
    
    <style>
        /* ===== RESET & BASE ===== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8fafc; color: #1e293b; line-height: 1.4; }
        .container { max-width: 1200px; margin: 0 auto; padding: 15px; }
        
        /* ===== HEADER ===== */
        .header { background: white; padding: 15px 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .logo { font-size: 1.8rem; }
        .header-title { font-size: 1.2rem; font-weight: 600; color: #2563eb; }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .user-badge { background: #e0f2fe; color: #0369a1; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        
        /* ===== TABS ===== */
        .tabs { display: flex; gap: 2px; background: #e2e8f0; padding: 2px; border-radius: 8px; margin-bottom: 20px; }
        .tab { flex: 1; padding: 12px; text-align: center; background: white; border: none; font-weight: 600; color: #64748b; cursor: pointer; transition: all 0.3s; }
        .tab:first-child { border-radius: 6px 0 0 6px; }
        .tab:last-child { border-radius: 0 6px 6px 0; }
        .tab.active { background: #2563eb; color: white; }
        
        /* ===== FORMS ===== */
        .card { background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .card-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 20px; color: #1e293b; display: flex; align-items: center; gap: 8px; }
        
        .form-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 15px; }
        .form-group { display: flex; flex-direction: column; }
        .form-label { font-size: 0.75rem; font-weight: 600; color: #64748b; margin-bottom: 6px; text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 10px 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 0.9rem; transition: all 0.2s; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        #nameInput, #detailsInput, #groupInput { text-transform: uppercase; }
        
        /* ===== BUTTONS ===== */
        .btn { padding: 10px 20px; border: none; border-radius: 6px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: #2563eb; color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #0da271; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-warning:hover { background: #d97706; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-secondary { background: #64748b; color: white; }
        .btn-secondary:hover { background: #475569; }
        
        .btn-small { padding: 6px 12px; font-size: 0.8rem; }
        .btn-wide { width: 100%; justify-content: center; }
        
        /* ===== TABLES ===== */
        .table-container { overflow-x: auto; }
        .table { width: 100%; border-collapse: collapse; }
        .table th { background: #f1f5f9; padding: 12px 15px; text-align: left; font-weight: 600; font-size: 0.75rem; color: #64748b; text-transform: uppercase; border-bottom: 2px solid #e2e8f0; }
        .table td { padding: 12px 15px; border-bottom: 1px solid #e2e8f0; vertical-align: middle; }
        .table tr:hover { background: #f8fafc; }
        .table tr.pending { background: #fffbeb; }
        .table tr.approved { background: #f0fdf4; }
        
        .item-name { font-weight: 600; color: #1e293b; text-transform: uppercase; }
        .item-quantity { font-weight: 700; color: #2563eb; }
        .item-group { background: #e0f2fe; color: #0369a1; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; display: inline-block; }
        
        .action-buttons { display: flex; gap: 5px; }
        .action-btn { padding: 4px 8px; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer; }
        .edit-btn { background: #f59e0b; color: white; }
        .delete-btn { background: #ef4444; color: white; }
        .approve-btn { background: #10b981; color: white; }
        .reject-btn { background: #ef4444; color: white; }
        
        /* ===== BATCH SYSTEM ===== */
        .batch-section { background: #f0fdf4; border: 2px dashed #10b981; border-radius: 10px; padding: 20px; margin-bottom: 20px; }
        .batch-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .batch-actions { display: flex; gap: 10px; }
        
        /* ===== STATUS BADGES ===== */
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; display: inline-block; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-approved { background: #d1fae5; color: #065f46; }
        .status-rejected { background: #fee2e2; color: #991b1b; }
        
        /* ===== MODALS ===== */
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; display: none; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 10px; padding: 25px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 15px; color: #1e293b; }
        .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        
        /* ===== LOGIN FORM ===== */
        .login-form { max-width: 400px; margin: 50px auto; }
        .login-form input { margin-bottom: 15px; }
        
        /* ===== UTILITY ===== */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .mt-10 { margin-top: 10px; }
        .mt-20 { margin-top: 20px; }
        .mb-10 { margin-bottom: 10px; }
        .mb-20 { margin-bottom: 20px; }
        
        /* ===== RESPONSIVE ===== */
        @media (max-width: 1024px) {
            .form-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
            .header { flex-direction: column; gap: 15px; align-items: stretch; }
            .table { font-size: 0.85rem; }
            .table th, .table td { padding: 8px 10px; }
        }
    </style>
</head>
<body>
    <!-- LOGIN MODAL -->
    <div id="loginModal" class="modal active">
        <div class="modal-content">
            <div class="card-title">üîê Login to Inventory System</div>
            <input type="password" id="loginPassword" placeholder="Enter password" class="mb-20">
            <div class="modal-buttons">
                <button id="loginStaffBtn" class="btn btn-secondary">Staff Login</button>
                <button id="loginAdminBtn" class="btn btn-primary">Admin Login</button>
            </div>
            <p class="text-center mt-10" style="color: #64748b; font-size: 0.85rem;">
                Staff: No password needed<br>
                Admin: Password required
            </p>
        </div>
    </div>

    <div class="container" id="mainApp" style="display: none;">
        <!-- HEADER -->
        <div class="header">
            <div class="header-left">
                <div class="logo">üì¶</div>
                <div class="header-title">INVENTORY MANAGEMENT SYSTEM</div>
            </div>
            <div class="user-info">
                <span class="user-badge" id="userRole">Staff</span>
                <button id="logoutBtn" class="btn btn-small btn-secondary">Logout</button>
            </div>
        </div>

        <!-- TABS -->
        <div class="tabs">
            <button class="tab active" data-tab="add">‚ûï Add Items</button>
            <button class="tab" data-tab="pending">‚è≥ Pending Batch</button>
            <button class="tab" data-tab="inventory">üìã Inventory</button>
            <button class="tab" data-tab="settings" id="settingsTab">‚öôÔ∏è Settings</button>
        </div>

        <!-- ADD ITEMS TAB -->
        <div id="addTab" class="tab-content">
            <div class="card">
                <div class="card-title">‚ûï ADD NEW ITEMS</div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Item Name</label>
                        <input type="text" id="nameInput" placeholder="ITEM NAME" autocapitalize="characters">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Quantity</label>
                        <input type="number" id="quantityInput" placeholder="0" min="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Group</label>
                        <input type="text" id="groupInput" placeholder="Enter group name" autocapitalize="characters">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Details</label>
                        <input type="text" id="detailsInput" placeholder="Details (Optional)" autocapitalize="characters">
                    </div>
                </div>
                <button id="addItemBtn" class="btn btn-primary btn-wide">‚ûï ADD TO BATCH</button>
            </div>

            <!-- CURRENT BATCH -->
            <div class="batch-section">
                <div class="batch-header">
                    <div class="card-title">üì¶ CURRENT BATCH</div>
                    <div class="batch-actions">
                        <button id="clearBatchBtn" class="btn btn-danger btn-small">üóëÔ∏è Clear Batch</button>
                        <button id="submitBatchBtn" class="btn btn-success btn-small">üì§ Submit for Approval</button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="table" id="batchTable">
                        <thead>
                            <tr>
                                <th width="30%">Item Name</th>
                                <th width="15%">Quantity</th>
                                <th width="20%">Group</th>
                                <th width="25%">Details</th>
                                <th width="10%">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="batchItems">
                            <!-- Batch items will appear here -->
                        </tbody>
                    </table>
                </div>
                <div class="text-right mt-10">
                    <span id="batchCount">0 items in batch</span>
                </div>
            </div>
        </div>

        <!-- PENDING BATCH TAB -->
        <div id="pendingTab" class="tab-content hidden">
            <div class="card">
                <div class="card-title">‚è≥ PENDING APPROVAL</div>
                <div class="table-container">
                    <table class="table" id="pendingTable">
                        <thead>
                            <tr>
                                <th width="25%">Item Name</th>
                                <th width="10%">Quantity</th>
                                <th width="15%">Group</th>
                                <th width="20%">Details</th>
                                <th width="15%">Added By</th>
                                <th width="15%">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="pendingItems">
                            <!-- Pending items will appear here -->
                        </tbody>
                    </table>
                </div>
                <div id="adminBatchActions" class="hidden mt-20">
                    <div class="card-title">üëë ADMIN ACTIONS</div>
                    <div style="display: flex; gap: 10px;">
                        <button id="approveAllBtn" class="btn btn-success">‚úÖ Approve All</button>
                        <button id="rejectAllBtn" class="btn btn-danger">‚ùå Reject All</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- INVENTORY TAB -->
        <div id="inventoryTab" class="tab-content hidden">
            <div class="card">
                <div class="card-title">üìã CURRENT INVENTORY</div>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="searchInput" placeholder="üîç Search items..." style="flex: 1;">
                    <select id="filterGroup">
                        <option value="">All Groups</option>
                        <!-- Groups will be populated -->
                    </select>
                </div>
                <div class="table-container">
                    <table class="table" id="inventoryTable">
                        <thead>
                            <tr>
                                <th width="25%">Item Name</th>
                                <th width="10%">Quantity</th>
                                <th width="15%">Group</th>
                                <th width="30%">Details</th>
                                <th width="20%">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryItems">
                            <!-- Inventory items will appear here -->
                        </tbody>
                    </table>
                </div>
                <div class="text-right mt-10">
                    <span id="inventoryCount">0 items in inventory</span>
                </div>
            </div>
        </div>

        <!-- SETTINGS TAB -->
        <div id="settingsTabContent" class="tab-content hidden">
            <div class="card">
                <div class="card-title">‚öôÔ∏è SYSTEM SETTINGS</div>
                
                <!-- GITHUB SETUP -->
                <div class="mb-20">
                    <div class="form-label">GitHub Configuration</div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">GitHub Username</label>
                            <input type="text" id="githubUsername" placeholder="your-username" value="unique205">
                        </div>
                        <div class="form-group">
                            <label class="form-label">GitHub Token</label>
                            <input type="password" id="githubToken" placeholder="Enter token">
                        </div>
                    </div>
                    <button id="saveGithubBtn" class="btn btn-primary mt-10">üíæ Save GitHub Settings</button>
                    <p class="mt-10" style="font-size: 0.85rem; color: #64748b;">
                        Token is stored in your browser only. Required for syncing data.
                    </p>
                </div>
                
                <!-- DATA MANAGEMENT -->
                <div class="mb-20">
                    <div class="form-label">Data Management</div>
                    <div style="display: flex; gap: 10px;">
                        <button id="exportBtn" class="btn btn-secondary">üì• Export Data</button>
                        <button id="importBtn" class="btn btn-secondary">üì§ Import Data</button>
                        <input type="file" id="importFile" class="hidden" accept=".json">
                    </div>
                </div>
                
                <!-- ADMIN ACTIONS -->
                <div id="adminActions" class="hidden">
                    <div class="form-label">Admin Actions</div>
                    <div style="display: flex; gap: 10px;">
                        <button id="syncNowBtn" class="btn btn-success">üîÑ Sync Now</button>
                        <button id="clearAllBtn" class="btn btn-danger">üóëÔ∏è Clear All Data</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- DELETE CONFIRMATION MODAL -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">‚ö†Ô∏è Confirm Delete</div>
            <p id="deleteMessage">Are you sure you want to delete this item?</p>
            <div class="modal-buttons">
                <button id="cancelDeleteBtn" class="btn btn-secondary">Cancel</button>
                <button id="confirmDeleteBtn" class="btn btn-danger">Delete</button>
            </div>
        </div>
    </div>

    <!-- BATCH SUBMIT MODAL -->
    <div id="batchModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">üì§ Submit Batch</div>
            <p>Submit <span id="batchSubmitCount">0</span> items for admin approval?</p>
            <div class="modal-buttons">
                <button id="cancelBatchBtn" class="btn btn-secondary">Cancel</button>
                <button id="confirmBatchBtn" class="btn btn-success">Submit</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION & STATE
        // ============================================
        const CONFIG = {
            ADMIN_PASSWORD: 'Arshiyan2@',
            GITHUB_USERNAME: 'unique205',
            DATA_REPO: 'inventory-data',
            DATA_FILE: 'data/inventory.json',
            BRANCH: 'main'
        };

        let currentUser = null; // 'staff' or 'admin'
        let currentBatch = []; // Items staff is adding
        let pendingBatch = []; // Items waiting admin approval
        let inventory = []; // Approved items
        let githubToken = null;
        let isOnline = navigator.onLine;
        let deleteCallback = null;

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Inventory System Loading...');
            
            // Load saved data
            loadLocalData();
            
            // Setup event listeners
            setupEventListeners();
            
            // Update UI
            updateUI();
            
            // Check connection
            updateConnectionStatus();
        });

        // ============================================
        // DATA MANAGEMENT
        // ============================================
        function loadLocalData() {
            // Load inventory
            const savedInventory = localStorage.getItem('inventory_data');
            if (savedInventory) {
                try {
                    inventory = JSON.parse(savedInventory);
                } catch (e) {
                    inventory = [];
                }
            }
            
            // Load pending batch
            const savedPending = localStorage.getItem('pending_batch');
            if (savedPending) {
                try {
                    pendingBatch = JSON.parse(savedPending);
                } catch (e) {
                    pendingBatch = [];
                }
            }
            
            // Load current batch
            const savedBatch = localStorage.getItem('current_batch');
            if (savedBatch) {
                try {
                    currentBatch = JSON.parse(savedBatch);
                } catch (e) {
                    currentBatch = [];
                }
            }
            
            // Load GitHub token
            githubToken = localStorage.getItem('github_token');
            
            // Load user session
            const savedUser = localStorage.getItem('current_user');
            if (savedUser) {
                currentUser = savedUser;
                showMainApp();
            }
        }

        function saveLocalData() {
            localStorage.setItem('inventory_data', JSON.stringify(inventory));
            localStorage.setItem('pending_batch', JSON.stringify(pendingBatch));
            localStorage.setItem('current_batch', JSON.stringify(currentBatch));
            if (githubToken) {
                localStorage.setItem('github_token', githubToken);
            }
            if (currentUser) {
                localStorage.setItem('current_user', currentUser);
            }
        }

        // ============================================
        // USER AUTHENTICATION
        // ============================================
        function loginAsStaff() {
            currentUser = 'staff';
            localStorage.setItem('current_user', 'staff');
            showMainApp();
            showMessage('‚úÖ Logged in as Staff');
        }

        function loginAsAdmin(password) {
            if (password === CONFIG.ADMIN_PASSWORD) {
                currentUser = 'admin';
                localStorage.setItem('current_user', 'admin');
                showMainApp();
                showMessage('‚úÖ Logged in as Admin');
                return true;
            } else {
                showMessage('‚ùå Incorrect admin password');
                return false;
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('current_user');
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginModal').classList.add('active');
            showMessage('Logged out successfully');
        }

        function showMainApp() {
            document.getElementById('loginModal').classList.remove('active');
            document.getElementById('mainApp').style.display = 'block';
            
            // Update UI based on user role
            document.getElementById('userRole').textContent = currentUser === 'admin' ? 'Admin' : 'Staff';
            
            // Show/hide admin features
            const adminFeatures = document.querySelectorAll('.admin-only');
            adminFeatures.forEach(el => {
                el.classList.toggle('hidden', currentUser !== 'admin');
            });
            
            // Settings tab only for admin
            document.getElementById('settingsTab').classList.toggle('hidden', currentUser !== 'admin');
            
            // Update all tables
            updateBatchTable();
            updatePendingTable();
            updateInventoryTable();
            updateCounts();
        }

        // ============================================
        // BATCH MANAGEMENT (STAFF)
        // ============================================
        function addItemToBatch() {
            const name = document.getElementById('nameInput').value.trim().toUpperCase();
            const quantity = parseInt(document.getElementById('quantityInput').value);
            const group = document.getElementById('groupInput').value.trim().toUpperCase();
            const details = document.getElementById('detailsInput').value.trim().toUpperCase();
            
            // Validation
            if (!name) {
                showMessage('‚ùå Please enter item name');
                return;
            }
            if (!quantity || quantity < 1) {
                showMessage('‚ùå Please enter valid quantity');
                return;
            }
            if (!group) {
                showMessage('‚ùå Please enter group');
                return;
            }
            
            // Create item
            const newItem = {
                id: 'item_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                name: name,
                quantity: quantity,
                group: group,
                details: details,
                addedBy: 'Staff', // In real app, this would be actual username
                addedAt: new Date().toISOString(),
                status: 'pending'
            };
            
            // Add to batch
            currentBatch.push(newItem);
            
            // Clear form
            document.getElementById('nameInput').value = '';
            document.getElementById('quantityInput').value = '';
            document.getElementById('groupInput').value = '';
            document.getElementById('detailsInput').value = '';
            document.getElementById('nameInput').focus();
            
            // Save and update
            saveLocalData();
            updateBatchTable();
            updateCounts();
            
            showMessage('‚úÖ Item added to batch');
        }

        function removeFromBatch(itemId) {
            currentBatch = currentBatch.filter(item => item.id !== itemId);
            saveLocalData();
            updateBatchTable();
            updateCounts();
        }

        function clearBatch() {
            if (currentBatch.length === 0) {
                showMessage('‚ö†Ô∏è Batch is already empty');
                return;
            }
            
            if (confirm('Clear all items from current batch?')) {
                currentBatch = [];
                saveLocalData();
                updateBatchTable();
                updateCounts();
                showMessage('‚úÖ Batch cleared');
            }
        }

        function submitBatch() {
            if (currentBatch.length === 0) {
                showMessage('‚ùå No items in batch to submit');
                return;
            }
            
            document.getElementById('batchSubmitCount').textContent = currentBatch.length;
            document.getElementById('batchModal').classList.add('active');
        }

        function confirmBatchSubmit() {
            // Move all items from current batch to pending batch
            currentBatch.forEach(item => {
                pendingBatch.push({
                    ...item,
                    submittedAt: new Date().toISOString(),
                    status: 'pending'
                });
            });
            
            // Clear current batch
            currentBatch = [];
            
            // Save and update
            saveLocalData();
            updateBatchTable();
            updatePendingTable();
            updateCounts();
            
            // Close modal
            document.getElementById('batchModal').classList.remove('active');
            
            showMessage('‚úÖ Batch submitted for admin approval');
        }

        // ============================================
        // APPROVAL SYSTEM (ADMIN)
        // ============================================
        function approveItem(itemId) {
            const itemIndex = pendingBatch.findIndex(item => item.id === itemId);
            if (itemIndex === -1) return;
            
            const item = pendingBatch[itemIndex];
            
            // Check if item already exists in inventory
            const existingIndex = inventory.findIndex(invItem => 
                invItem.name === item.name && invItem.group === item.group
            );
            
            if (existingIndex !== -1) {
                // Update quantity
                inventory[existingIndex].quantity += item.quantity;
                inventory[existingIndex].updatedAt = new Date().toISOString();
                inventory[existingIndex].lastUpdatedBy = 'Admin';
            } else {
                // Add new item
                inventory.unshift({
                    ...item,
                    status: 'approved',
                    approvedAt: new Date().toISOString(),
                    approvedBy: 'Admin'
                });
            }
            
            // Remove from pending
            pendingBatch.splice(itemIndex, 1);
            
            saveLocalData();
            updatePendingTable();
            updateInventoryTable();
            updateCounts();
            
            showMessage('‚úÖ Item approved and added to inventory');
        }

        function rejectItem(itemId) {
            const itemIndex = pendingBatch.findIndex(item => item.id === itemId);
            if (itemIndex === -1) return;
            
            // Remove from pending
            pendingBatch.splice(itemIndex, 1);
            
            saveLocalData();
            updatePendingTable();
            updateCounts();
            
            showMessage('‚úÖ Item rejected');
        }

        function approveAllPending() {
            if (pendingBatch.length === 0) {
                showMessage('‚ùå No pending items to approve');
                return;
            }
            
            if (!confirm(`Approve all ${pendingBatch.length} pending items?`)) {
                return;
            }
            
            pendingBatch.forEach(item => {
                // Check if item exists
                const existingIndex = inventory.findIndex(invItem => 
                    invItem.name === item.name && invItem.group === item.group
                );
                
                if (existingIndex !== -1) {
                    inventory[existingIndex].quantity += item.quantity;
                    inventory[existingIndex].updatedAt = new Date().toISOString();
                } else {
                    inventory.unshift({
                        ...item,
                        status: 'approved',
                        approvedAt: new Date().toISOString(),
                        approvedBy: 'Admin'
                    });
                }
            });
            
            pendingBatch = [];
            
            saveLocalData();
            updatePendingTable();
            updateInventoryTable();
            updateCounts();
            
            showMessage(`‚úÖ All ${inventory.length} items approved`);
        }

        function rejectAllPending() {
            if (pendingBatch.length === 0) {
                showMessage('‚ùå No pending items to reject');
                return;
            }
            
            if (!confirm(`Reject all ${pendingBatch.length} pending items?`)) {
                return;
            }
            
            pendingBatch = [];
            
            saveLocalData();
            updatePendingTable();
            updateCounts();
            
            showMessage('‚úÖ All pending items rejected');
        }

        // ============================================
        // INVENTORY MANAGEMENT
        // ============================================
        function deleteInventoryItem(itemId) {
            const itemIndex = inventory.findIndex(item => item.id === itemId);
            if (itemIndex === -1) return;
            
            const item = inventory[itemIndex];
            
            if (confirm(`Delete "${item.name}" from inventory?`)) {
                inventory.splice(itemIndex, 1);
                saveLocalData();
                updateInventoryTable();
                updateCounts();
                showMessage('‚úÖ Item deleted from inventory');
            }
        }

        function updateInventoryItem(itemId, newQuantity) {
            const itemIndex = inventory.findIndex(item => item.id === itemId);
            if (itemIndex === -1) return;
            
            if (newQuantity >= 0) {
                inventory[itemIndex].quantity = newQuantity;
                inventory[itemIndex].updatedAt = new Date().toISOString();
                inventory[itemIndex].lastUpdatedBy = currentUser === 'admin' ? 'Admin' : 'Staff';
                
                saveLocalData();
                updateInventoryTable();
                showMessage('‚úÖ Quantity updated');
            }
        }

        function searchInventory() {
            const searchTerm = document.getElementById('searchInput').value.toUpperCase();
            const filterGroup = document.getElementById('filterGroup').value;
            
            updateInventoryTable(searchTerm, filterGroup);
        }

        // ============================================
        // UI UPDATES
        // ============================================
        function updateUI() {
            updateBatchTable();
            updatePendingTable();
            updateInventoryTable();
            updateCounts();
            updateGroupsFilter();
        }

        function updateBatchTable() {
            const tbody = document.getElementById('batchItems');
            
            if (currentBatch.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center" style="padding: 40px; color: #64748b;">
                            No items in current batch. Add items above.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = currentBatch.map(item => `
                <tr>
                    <td class="item-name">${item.name}</td>
                    <td class="item-quantity">${item.quantity}</td>
                    <td><span class="item-group">${item.group}</span></td>
                    <td>${item.details || '-'}</td>
                    <td>
                        <div class="action-buttons">
                            <button onclick="removeFromBatch('${item.id}')" class="action-btn delete-btn" title="Remove">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function updatePendingTable() {
            const tbody = document.getElementById('pendingItems');
            
            if (pendingBatch.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center" style="padding: 40px; color: #64748b;">
                            No pending items for approval.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = pendingBatch.map(item => `
                <tr class="pending">
                    <td class="item-name">${item.name}</td>
                    <td class="item-quantity">${item.quantity}</td>
                    <td><span class="item-group">${item.group}</span></td>
                    <td>${item.details || '-'}</td>
                    <td>${item.addedBy}</td>
                    <td>
                        ${currentUser === 'admin' ? `
                            <div class="action-buttons">
                                <button onclick="approveItem('${item.id}')" class="action-btn approve-btn" title="Approve">‚úÖ</button>
                                <button onclick="rejectItem('${item.id}')" class="action-btn reject-btn" title="Reject">‚ùå</button>
                            </div>
                        ` : `
                            <span class="status-badge status-pending">Waiting Approval</span>
                        `}
                    </td>
                </tr>
            `).join('');
            
            // Show admin actions if admin is logged in
            document.getElementById('adminBatchActions').classList.toggle('hidden', currentUser !== 'admin');
        }

        function updateInventoryTable(searchTerm = '', filterGroup = '') {
            const tbody = document.getElementById('inventoryItems');
            
            // Filter items
            let filteredItems = [...inventory];
            
            if (searchTerm) {
                filteredItems = filteredItems.filter(item => 
                    item.name.includes(searchTerm) || 
                    (item.details && item.details.includes(searchTerm))
                );
            }
            
            if (filterGroup) {
                filteredItems = filteredItems.filter(item => item.group === filterGroup);
            }
            
            if (filteredItems.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center" style="padding: 40px; color: #64748b;">
                            No items found${searchTerm || filterGroup ? ' matching your criteria' : ''}.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = filteredItems.map(item => `
                <tr class="approved">
                    <td class="item-name">${item.name}</td>
                    <td>
                        <input type="number" value="${item.quantity}" min="0" 
                               onchange="updateInventoryItem('${item.id}', this.value)"
                               style="width: 70px; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;">
                    </td>
                    <td><span class="item-group">${item.group}</span></td>
                    <td>${item.details || '-'}</td>
                    <td>
                        <div class="action-buttons">
                            ${currentUser === 'admin' ? `
                                <button onclick="deleteInventoryItem('${item.id}')" class="action-btn delete-btn" title="Delete">üóëÔ∏è</button>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function updateGroupsFilter() {
            const select = document.getElementById('filterGroup');
            const groups = new Set();
            
            // Add groups from inventory
            inventory.forEach(item => groups.add(item.group));
            // Add groups from pending
            pendingBatch.forEach(item => groups.add(item.group));
            // Add groups from current batch
            currentBatch.forEach(item => groups.add(item.group));
            
            // Clear and add options
            select.innerHTML = '<option value="">All Groups</option>';
            Array.from(groups).sort().forEach(group => {
                if (group) {
                    select.innerHTML += `<option value="${group}">${group}</option>`;
                }
            });
        }

        function updateCounts() {
            document.getElementById('batchCount').textContent = `${currentBatch.length} items in batch`;
            document.getElementById('inventoryCount').textContent = `${inventory.length} items in inventory`;
        }

        function updateConnectionStatus() {
            // Simple status for now
            // Could add GitHub sync status here
        }

        // ============================================
        // TAB SYSTEM
        // ============================================
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Update data for the tab
            if (tabName === 'inventory') {
                updateInventoryTable();
            } else if (tabName === 'pending') {
                updatePendingTable();
            }
        }

        // ============================================
        // GITHUB SYNC FUNCTIONS
        // ============================================
        async function syncWithGitHub() {
            if (!githubToken || !isOnline) {
                showMessage('‚ùå Cannot sync: No token or offline');
                return;
            }
            
            try {
                showMessage('üîÑ Syncing with GitHub...');
                
                // Read current data from GitHub
                let remoteData = await readFromGitHub();
                
                // Merge data (GitHub as source of truth for approved items)
                const mergedInventory = [...remoteData];
                
                // Add local approved items that don't exist remotely
                inventory.forEach(localItem => {
                    const exists = mergedInventory.some(remoteItem => 
                        remoteItem.id === localItem.id || 
                        (remoteItem.name === localItem.name && remoteItem.group === localItem.group)
                    );
                    if (!exists) {
                        mergedInventory.push(localItem);
                    }
                });
                
                // Write back to GitHub
                await writeToGitHub(mergedInventory);
                
                // Update local inventory with merged data
                inventory = mergedInventory;
                saveLocalData();
                updateInventoryTable();
                
                showMessage('‚úÖ Synced with GitHub');
                
            } catch (error) {
                console.error('Sync failed:', error);
                showMessage('‚ùå Sync failed: ' + error.message);
            }
        }

        async function readFromGitHub() {
            const url = `https://api.github.com/repos/${CONFIG.GITHUB_USERNAME}/${CONFIG.DATA_REPO}/contents/${CONFIG.DATA_FILE}`;
            
            const response = await fetch(url, {
                headers: {
                    'Authorization': `token ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (response.status === 404) {
                return []; // File doesn't exist yet
            }
            
            if (!response.ok) {
                throw new Error(`GitHub error: ${response.status}`);
            }
            
            const data = await response.json();
            const content = atob(data.content.replace(/\n/g, ''));
            return JSON.parse(content);
        }

        async function writeToGitHub(data) {
            const url = `https://api.github.com/repos/${CONFIG.GITHUB_USERNAME}/${CONFIG.DATA_REPO}/contents/${CONFIG.DATA_FILE}`;
            
            // Get current SHA if file exists
            let sha = null;
            try {
                const info = await readFromGitHub();
                const infoResponse = await fetch(url, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                if (infoResponse.ok) {
                    const infoData = await infoResponse.json();
                    sha = infoData.sha;
                }
            } catch (e) {
                // File doesn't exist
            }
            
            const content = btoa(JSON.stringify(data, null, 2));
            const body = {
                message: `Inventory sync ${new Date().toLocaleString()}`,
                content: content,
                branch: CONFIG.BRANCH
            };
            
            if (sha) {
                body.sha = sha;
            }
            
            const response = await fetch(url, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });
            
            if (!response.ok) {
                throw new Error(`GitHub write error: ${response.status}`);
            }
            
            return await response.json();
        }

        function saveGithubSettings() {
            const username = document.getElementById('githubUsername').value.trim();
            const token = document.getElementById('githubToken').value.trim();
            
            if (!username || !token) {
                showMessage('‚ùå Please enter both username and token');
                return;
            }
            
            CONFIG.GITHUB_USERNAME = username;
            githubToken = token;
            
            localStorage.setItem('github_token', token);
            
            showMessage('‚úÖ GitHub settings saved');
        }

        // ============================================
        // DATA IMPORT/EXPORT
        // ============================================
        function exportData() {
            try {
                const data = {
                    inventory: inventory,
                    exportedAt: new Date().toISOString(),
                    exportedBy: currentUser
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `inventory-export-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                URL.revokeObjectURL(url);
                
                showMessage('‚úÖ Data exported successfully');
            } catch (error) {
                showMessage('‚ùå Export failed');
            }
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!confirm('Import will replace ALL current inventory data. Continue?')) {
                event.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.inventory && Array.isArray(data.inventory)) {
                        inventory = data.inventory;
                        saveLocalData();
                        updateInventoryTable();
                        updateGroupsFilter();
                        showMessage(`‚úÖ Imported ${inventory.length} items`);
                    } else {
                        showMessage('‚ùå Invalid import file format');
                    }
                } catch (error) {
                    showMessage('‚ùå Error reading import file');
                }
            };
            reader.readAsText(file);
            
            event.target.value = '';
        }

        function clearAllData() {
            if (!confirm('‚ö†Ô∏è This will delete ALL data including inventory, pending, and batches. Continue?')) {
                return;
            }
            
            if (prompt('Type "DELETE ALL" to confirm:') === 'DELETE ALL') {
                inventory = [];
                pendingBatch = [];
                currentBatch = [];
                
                localStorage.clear();
                githubToken = null;
                currentUser = null;
                
                // Reload page
                location.reload();
            }
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        function setupEventListeners() {
            // Login buttons
            document.getElementById('loginStaffBtn').addEventListener('click', loginAsStaff);
            document.getElementById('loginAdminBtn').addEventListener('click', () => {
                const password = document.getElementById('loginPassword').value;
                loginAsAdmin(password);
            });
            
            // Enter key in login
            document.getElementById('loginPassword').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const password = document.getElementById('loginPassword').value;
                    loginAsAdmin(password);
                }
            });
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // Tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const tabName = e.target.dataset.tab;
                    switchTab(tabName);
                });
            });
            
            // Add item
            document.getElementById('addItemBtn').addEventListener('click', addItemToBatch);
            document.getElementById('nameInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addItemToBatch();
            });
            
            // Batch actions
            document.getElementById('clearBatchBtn').addEventListener('click', clearBatch);
            document.getElementById('submitBatchBtn').addEventListener('click', submitBatch);
            
            // Batch modal
            document.getElementById('cancelBatchBtn').addEventListener('click', () => {
                document.getElementById('batchModal').classList.remove('active');
            });
            document.getElementById('confirmBatchBtn').addEventListener('click', confirmBatchSubmit);
            
            // Admin actions
            document.getElementById('approveAllBtn').addEventListener('click', approveAllPending);
            document.getElementById('rejectAllBtn').addEventListener('click', rejectAllPending);
            
            // Search
            document.getElementById('searchInput').addEventListener('input', searchInventory);
            document.getElementById('filterGroup').addEventListener('change', searchInventory);
            
            // Settings
            document.getElementById('saveGithubBtn').addEventListener('click', saveGithubSettings);
            document.getElementById('exportBtn').addEventListener('click', exportData);
            document.getElementById('importBtn').addEventListener('click', () => {
                document.getElementById('importFile').click();
            });
            document.getElementById('importFile').addEventListener('change', importData);
            document.getElementById('syncNowBtn').addEventListener('click', syncWithGitHub);
            document.getElementById('clearAllBtn').addEventListener('click', clearAllData);
            
            // Online/offline
            window.addEventListener('online', () => {
                isOnline = true;
                showMessage('üü¢ Online');
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                showMessage('üî¥ Offline - Working locally');
            });
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function showMessage(message) {
            // Remove existing
            const existing = document.querySelector('.message-toast');
            if (existing) existing.remove();
            
            // Create new
            const messageEl = document.createElement('div');
            messageEl.className = 'message-toast';
            messageEl.textContent = message;
            messageEl.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: ${message.includes('‚úÖ') ? '#10b981' : message.includes('‚ùå') ? '#ef4444' : message.includes('‚ö†Ô∏è') ? '#f59e0b' : '#2563eb'};
                color: white;
                padding: 10px 20px;
                border-radius: 6px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1000;
                font-size: 0.9rem;
                animation: slideIn 0.3s ease-out;
            `;
            
            document.body.appendChild(messageEl);
            
            setTimeout(() => {
                if (messageEl.parentNode) {
                    messageEl.style.animation = 'slideOut 0.3s ease-out forwards';
                    setTimeout(() => {
                        if (messageEl.parentNode) {
                            messageEl.parentNode.removeChild(messageEl);
                        }
                    }, 300);
                }
            }, 3000);
        }

        // Add animation styles
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            .tab-content { display: block; }
        `;
        document.head.appendChild(style);

        // Make functions globally available
        window.removeFromBatch = removeFromBatch;
        window.approveItem = approveItem;
        window.rejectItem = rejectItem;
        window.deleteInventoryItem = deleteInventoryItem;
        window.updateInventoryItem = updateInventoryItem;
    </script>
</body>
</html>
