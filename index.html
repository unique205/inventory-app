// index.js - inventory backend with GitHub App token + batch notification stub

const express = require("express");
const cors = require("cors");
const dotenv = require("dotenv");
const { createAppAuth } = require("@octokit/auth-app");

dotenv.config();

const app = express();
const PORT = process.env.PORT || 3000;

// ===== CONFIG FROM ENV =====
// Make sure these are set in Render environment
const APP_ID = process.env.GITHUB_APP_ID;
const PRIVATE_KEY = process.env.GITHUB_PRIVATE_KEY?.replace(/\\n/g, "\n");
const INSTALLATION_ID = process.env.GITHUB_INSTALLATION_ID;

// Basic safety check
if (!APP_ID || !PRIVATE_KEY || !INSTALLATION_ID) {
  console.warn(
    "⚠️ Missing GitHub App config. Please set GITHUB_APP_ID, GITHUB_PRIVATE_KEY, GITHUB_INSTALLATION_ID."
  );
}

app.use(cors());
app.use(express.json());

// Simple health check
app.get("/", (req, res) => {
  res.send("Inventory backend is running ✅");
});

// ===== /get-token: return installation access token =====
app.post("/get-token", async (req, res) => {
  try {
    const auth = createAppAuth({
      appId: APP_ID,
      privateKey: PRIVATE_KEY,
      installationId: INSTALLATION_ID,
    });

    const installationAuthentication = await auth({ type: "installation" });

    res.json({ token: installationAuthentication.token });
  } catch (err) {
    console.error("Error getting installation token:", err);
    res.status(500).json({ error: "Failed to get installation token" });
  }
});

// ===== /notify-batch: stub for WhatsApp notification =====
// Frontend sends: { phone, batchTime, items: [{name, quantity, group, details}, ...] }
app.post("/notify-batch", async (req, res) => {
  try {
    const { phone, batchTime, items } = req.body || {};

    if (!phone || !items || !Array.isArray(items) || !items.length) {
      return res.status(400).json({ error: "Invalid payload" });
    }

    // Message text (you can format however you like)
    const lines = [];
    lines.push(`BATCH TIME: ${batchTime}`);
    lines.push("ITEMS:");
    for (const item of items) {
      const line = [
        item.name || "",
        `QTY: ${item.quantity ?? ""}`,
        item.group ? `GROUP: ${item.group}` : "",
        item.details ? `DETAILS: ${item.details}` : "",
      ]
        .filter(Boolean)
        .join(" | ");
      lines.push(line);
    }
    const messageText = lines.join("\n");

    // === PLACEHOLDER ===
    console.log("==== BATCH NOTIFICATION REQUEST ====");
    console.log("To phone:", phone);
    console.log("Message:\n", messageText);
    console.log("====================================");

    // TODO: integrate real WhatsApp sending here.
    // Example (pseudo):
    //
    // await axios.post("https://graph.facebook.com/v19.0/<PHONE_NUMBER_ID>/messages", {
    //   messaging_product: "whatsapp",
    //   to: phone,
    //   type: "text",
    //   text: { body: messageText },
    // }, {
    //   headers: { Authorization: `Bearer ${process.env.WHATSAPP_TOKEN}` }
    // });
    //
    // or Twilio's WhatsApp API.

    res.json({ ok: true });
  } catch (err) {
    console.error("Error in /notify-batch:", err);
    res.status(500).json({ error: "Failed to process batch notification" });
  }
});

app.listen(PORT, () => {
  console.log(`Backend running on port ${PORT}`);
});
